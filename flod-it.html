<!doctype>
<html>
<head>
    <meta charset="utf-8">
    <style type="text/css">
        canvas#canvas {
            border: 1px solid black;}
        div#log {
            height: 8em;
            width: 100%;
            overflow: auto;}
    </style>

    <script type="text/javascript">
    /*<![CDATA[  */
        function Vector (x, y){
            this.x = x || 0;
            this.y = y || 0;
            this.size;
        }

        function $ (el){ return document.getElementById(el); }
        function log (msg) { $("log").innerHTML = msg + "<br>" + $("log").innerHTML; }

        var cores = ['#33FF00', '#6600FF', '#FFFF00', '#FF0000', '#66FFFF'];
        function rect(ctx, x, y, w, h, cor){
            ctx.fillStyle = cor;
            ctx.fillRect(x, y, w, h);
        }

        var blocks_array = [];
        var blocks_painted = [];
        var menu = [];
        var blocks = 10;
        var block_width = 50;
        var ctx;

        window.onload = function() {
            log($("canvas").offsetTop + ", " + $("canvas").offsetLeft);
            var canvas = $("canvas");
            ctx = canvas.getContext("2d");

            for(var i=0; i<blocks; i++){
                blocks_array[i] = [];
                blocks_painted[i] = [];
                for(var j=0; j<blocks; j++){
                    var cor = cores[Math.floor(Math.random()*cores.length)];
                    blocks_array[i][j] = cor;
                    blocks_painted[i][j] = false;
                }
            }

            for(var i=0; i<cores.length; i++){
                menu[i] = new Vector();
                menu[i].x = 525;
                menu[i].y = (i*50)+((1+i)*10);
                menu[i].size = block_width;

                rect(ctx, 525, menu[i].y, block_width, block_width, cores[i]);
            }

            draw();
        };

        function draw(){
            for(var i=0; i<blocks; i++){
                for(var j=0; j<blocks; j++){
                    rect(ctx, i*block_width, j*block_width, block_width, block_width, blocks_array[i][j]);
                }
            }
        }

        function getClickCoord(e){
            var c_offset = canvasPosition(); 
            
            var result = new Vector(e.pageX - c_offset.x, e.pageY - c_offset.y);
            //var result = new Vector(e.pageX, e.pageY);
            return result;
        }

        function canvasPosition(){
            return new Vector($("canvas").offsetLeft, $("canvas").offsetTop);
        }

        document.onmousedown = function(e){
            var click_coord = getClickCoord(e);
            var selected;

            for(var i=0; i<menu.length; i++){
                x = click_coord.x;
                y = click_coord.y;

                if(x > menu[i].x && x < menu[i].x + menu[i].size &&
                    y > menu[i].y && y < menu[i].y + menu[i].size){

                    selected = cores[i];
                    break;
                }
            }

            if(selected != null){
                flodit(selected);
                log(selected);
            }
        }

        function flodit(new_cor){
            // resta os blocos pintados
            for(var i=0; i<blocks_painted.length; i++){
                for(var j=0; j<blocks_painted.length; j++){
                    blocks_painted[i][j] = false;
                }
            }
            blocks_painted[0][0] = true;

            var cor = blocks_array[0][0];
            var same_color = [new Vector(0, 0)];
            var flooded = [];

            for(var b=0; b<same_color.length; b++) {
                    // pega vizinhos
                    x = same_color[b].x;
                    y = same_color[b].y;

                    if(x>0)
                        if(blocks_array[x-1][y] == cor && !blocks_painted[x-1][y]){
                            same_color.push(new Vector(x-1, y));
                            blocks_painted[x-1][y] = true;
                        }
                        else if(blocks_array[x-1][y] == new_cor)
                            flooded.push(new Vector(x-1, y));

                    if(x<blocks_array.length-1)
                        if(blocks_array[x+1][y] == cor && !blocks_painted[x+1][y]){
                            same_color.push(new Vector(x+1, y));
                            blocks_painted[x+1][y] = true;
                        }
                        else if(blocks_array[x+1][y] == new_cor)
                            flooded.push(new Vector(x+1, y));

                    if(y>0)
                        if(blocks_array[x][y-1] == cor && !blocks_painted[x][y-1]){
                            same_color.push(new Vector(x, y-1));
                            blocks_painted[x][y-1] = true;
                        }
                        else if(blocks_array[x][y-1] == new_cor)
                            flooded.push(new Vector(x, y-1));

                    if(y<blocks_array[x].length-1)
                        if(blocks_array[x][y+1] == cor && !blocks_painted[x][y+1]){
                            same_color.push(new Vector(x, y+1));
                            blocks_painted[x][y+1] = true;
                        }
                        else if(blocks_array[x][y+1] == new_cor)
                            flooded.push(new Vector(x, y+1));

                    blocks_array[x][y] = new_cor;
            }
            for(b in flooded){
                blocks_array[flooded[b].x][flooded[b].y] = new_cor;
            }

            draw();
        }

    /* ]]>*/
    </script>
</head>

<body>
    <center>
    <canvas id="canvas" width="600" height="500"></canvas>
    </center>

    <div id="log"></div>
</body>
</html>
